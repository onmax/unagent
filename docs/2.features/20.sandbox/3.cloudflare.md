---
icon: i-simple-icons-cloudflare
---
# Cloudflare

> Cloudflare-specific sandbox features via the `sandbox.cloudflare` namespace.

## Usage

### Setup
```ts
import { getSandbox, Sandbox } from '@cloudflare/sandbox'
import { createSandbox } from 'unagent/sandbox'

export { Sandbox } // Required: export DO class

export default {
  async fetch(req: Request, env: Env) {
    const sandbox = await createSandbox({
      provider: { name: 'cloudflare', namespace: env.SANDBOX, getSandbox },
    })

    // Access Cloudflare namespace
    const cf = sandbox.cloudflare
  },
}
```

## API

### CloudflareNamespace API
#### Git Operations

Clone repositories into the sandbox:

```ts
const result = await sandbox.cloudflare.gitCheckout(
  'https://github.com/user/repo',
  { branch: 'main', depth: 1 }
)
// { success: true, path: '/repo', branch: 'main', commit: 'abc123' }
```

Options:
- `branch` - Branch to checkout
- `depth` - Shallow clone depth
- `sparse` - Sparse checkout paths

### Sessions

Create isolated execution sessions:

```ts
// Create session
const session = await sandbox.cloudflare.createSession({
  cwd: '/app',
  env: { NODE_ENV: 'development' },
})

// Execute in session
const result = await session.exec('npm run build')

// Start process in session
const proc = await session.startProcess('npm', ['run', 'dev'])

// Cleanup
await session.destroy()
await sandbox.cloudflare.deleteSession(session.id)
```

### Code Interpreter

Run Python or JavaScript code directly:

```ts
// Python
const pyResult = await sandbox.cloudflare.runCode(
  'print("Hello from Python!")',
  { language: 'python' }
)

// JavaScript
const jsResult = await sandbox.cloudflare.runCode(
  'console.log("Hello from JS!")',
  { language: 'javascript' }
)

// With persistent context
const ctx = await sandbox.cloudflare.createCodeContext({ language: 'python' })
await sandbox.cloudflare.runCode('x = 42', { context: ctx })
await sandbox.cloudflare.runCode('print(x)', { context: ctx }) // 42

// Cleanup
await sandbox.cloudflare.deleteCodeContext(ctx.id)
```

### Port Exposure

Expose internal ports to the internet:

```ts
// Expose port
const { url } = await sandbox.cloudflare.exposePort(8080, {
  protocol: 'http',
  hostname: 'custom.example.com',
})

// List exposed ports
const ports = await sandbox.cloudflare.getExposedPorts('custom.example.com')

// Unexpose
await sandbox.cloudflare.unexposePort(8080)
```

`hostname` is required and should be a custom domain hostname.

### Bucket Mounting

Mount R2 buckets into the filesystem:

```ts
await sandbox.cloudflare.mountBucket('my-bucket', '/mnt/data', {
  readonly: false,
})

// Use files from bucket
const content = await sandbox.readFile('/mnt/data/file.txt')

// Unmount when done
await sandbox.cloudflare.unmountBucket('/mnt/data')
```

### Environment Variables

Set environment variables at runtime:

```ts
await sandbox.cloudflare.setEnvVars({
  API_KEY: 'secret',
  DEBUG: 'true',
  OLD_VAR: undefined, // Delete variable
})
```

### WebSocket Proxy

Proxy WebSocket connections to internal ports:

```ts
export default {
  async fetch(req: Request, env: Env) {
    const sandbox = await createSandbox({
      provider: { name: 'cloudflare', namespace: env.SANDBOX, getSandbox },
    })

    // Start WebSocket server in sandbox
    await sandbox.startProcess('node', ['ws-server.js'])

    // Proxy WebSocket connection
    if (req.headers.get('Upgrade') === 'websocket') {
      return sandbox.cloudflare.wsConnect(req, 8080)
    }
  },
}
```

### native

Escape hatch to the underlying SDK stub:

```ts
const stub = sandbox.cloudflare.native
// Direct access to @cloudflare/sandbox stub
```

### Full File Operations
Cloudflare supports full file system operations:

```ts
// List files
const files = await sandbox.listFiles('/app', { recursive: true })
// [{ name: 'index.js', path: '/app/index.js', type: 'file', size: 1234 }, ...]

// Check existence
const exists = await sandbox.exists('/app/config.json')

// Move/rename
await sandbox.moveFile('/app/old.txt', '/app/new.txt')

// Delete
await sandbox.deleteFile('/app/temp.txt')
```

### Capabilities
Check provider support for optional features:

```ts
if (sandbox.supports.listFiles) {
  const files = await sandbox.listFiles('/app', { recursive: true })
}
```

### Cloudflare Provider Options
```ts
interface CloudflareProviderOptions {
  name: 'cloudflare'
  namespace: DurableObjectNamespace // Required
  getSandbox?: typeof getSandbox // Optional (auto-loaded if omitted)
  sandboxId?: string // Custom ID
  cloudflare?: {
    sleepAfter?: string | number // Auto-sleep duration
    keepAlive?: boolean // Prevent auto-sleep
    normalizeId?: boolean // Normalize sandbox IDs
  }
}
```

### wrangler.jsonc Configuration
```jsonc
{
  "name": "sandbox-worker",
  "main": "src/worker.ts",
  "compatibility_date": "2024-01-01",
  "durable_objects": {
    "bindings": [
      { "name": "SANDBOX", "class_name": "Sandbox" }
    ]
  },
  "migrations": [
    { "tag": "v1", "new_classes": ["Sandbox"] }
  ]
}
```

## Examples

### Full Example
```ts
import { getSandbox, Sandbox } from '@cloudflare/sandbox'
import { createSandbox } from 'unagent/sandbox'

export { Sandbox }

interface Env {
  SANDBOX: DurableObjectNamespace
  DATA_BUCKET: R2Bucket
}

export default {
  async fetch(req: Request, env: Env) {
    const sandbox = await createSandbox({
      provider: { name: 'cloudflare', namespace: env.SANDBOX, getSandbox },
    })

    try {
      // Clone repo
      await sandbox.cloudflare.gitCheckout('https://github.com/user/app', {
        branch: 'main',
        depth: 1,
      })

      // Mount data bucket
      await sandbox.cloudflare.mountBucket('data', '/mnt/data')

      // Install and build
      await sandbox.exec('npm', ['install'], { cwd: '/app' })
      await sandbox.exec('npm', ['run', 'build'], { cwd: '/app' })

      // Start dev server
      const proc = await sandbox.startProcess('npm', ['run', 'dev'], {
        cwd: '/app',
      })
      await proc.waitForPort(3000)

      // Expose to internet
      const { url } = await sandbox.cloudflare.exposePort(3000, {
        hostname: 'preview.example.com',
      })

      return Response.json({ url, status: 'running' })
    }
    finally {
      await sandbox.stop()
    }
  },
}
```

## Related
- [Sandbox](/features/sandbox)
- [All Features](/features)
- [All Modules](/modules)
