---
icon: i-lucide-box
---
# sandbox

> Create sandboxed execution environments with a unified API across Vercel and Cloudflare.

## Usage
```ts
import { createSandbox } from 'unagent/sandbox'
```

### Installation
Install `unagent` and the provider SDK for your platform:

::code-group
```bash [Vercel]
pnpm add unagent @vercel/sandbox
```
```bash [Cloudflare]
pnpm add unagent @cloudflare/sandbox
```
::

### Quick Start
#### Vercel

```ts
const sandbox = await createSandbox({
  provider: { name: 'vercel', runtime: 'node24', timeout: 300_000 },
})

const result = await sandbox.exec('node', ['-e', 'console.log("hello")'])
console.log(result.stdout) // "hello"

await sandbox.stop()
```

### Cloudflare Workers

Cloudflare requires a Durable Objects binding:

```ts
import { getSandbox, Sandbox } from '@cloudflare/sandbox'
import { createSandbox } from 'unagent/sandbox'

export { Sandbox }

export default {
  async fetch(req: Request, env: Env) {
    const sandbox = await createSandbox({
      provider: { name: 'cloudflare', namespace: env.SANDBOX, getSandbox },
    })

    const result = await sandbox.exec('echo', ['hello'])
    await sandbox.stop()

    return Response.json(result)
  },
}
```

## API

### Unified API
The sandbox API provides a consistent interface for both providers:

### Core Methods

```ts
interface Sandbox {
  readonly id: string
  readonly provider: 'vercel' | 'cloudflare'
  readonly supports: SandboxCapabilities

  // Execute commands
  exec: (cmd: string, args?: string[], opts?: SandboxExecOptions) => Promise<SandboxExecResult>

  // File operations
  writeFile: (path: string, content: string) => Promise<void>
  readFile: (path: string) => Promise<string>
  mkdir: (path: string, opts?: { recursive?: boolean }) => Promise<void>
  readFileStream: (path: string) => Promise<ReadableStream<Uint8Array>>

  // Background processes
  startProcess: (cmd: string, args?: string[], opts?: ProcessOptions) => Promise<SandboxProcess>

  // Lifecycle
  stop: () => Promise<void>
}
```

### Capabilities

Check provider support for optional features:

```ts
if (sandbox.supports.listFiles) {
  const files = await sandbox.listFiles('/app')
}
```

### Streaming Exec

Execute commands with real-time output streaming:

```ts
const result = await sandbox.exec('npm', ['install'], {
  cwd: '/app',
  timeout: 60_000,
  onStdout: data => console.log('[stdout]', data),
  onStderr: data => console.error('[stderr]', data),
})
```

### Background Processes

Start long-running processes and interact with them:

```ts
const process = await sandbox.startProcess('npm', ['run', 'dev'])

// Wait for server to start
await process.waitForLog(/ready in \d+ms/)

// Or wait for port
await process.waitForPort(3000, { timeout: 30_000 })

// Get logs
const { stdout, stderr } = await process.logs()

// Kill when done
await process.kill()
```

### SandboxProcess Interface

```ts
interface SandboxProcess {
  readonly id: string
  readonly command: string

  kill: (signal?: string) => Promise<void>
  logs: () => Promise<{ stdout: string, stderr: string }>
  wait: (timeout?: number) => Promise<{ exitCode: number }>
  waitForLog: (pattern: string | RegExp, timeout?: number) => Promise<{ line: string }>
  waitForPort: (port: number, opts?: WaitForPortOptions) => Promise<void>
}
```

### Provider-Specific Features
Access provider-specific APIs through namespaces:

::code-group
```ts [Vercel]
const sandbox = await createSandbox({
  provider: { name: 'vercel' },
})

// Access Vercel-specific features
const domain = sandbox.vercel.domain(3000)
const metadata = sandbox.vercel.getMetadata()
```

```ts [Cloudflare]
const sandbox = await createSandbox({
  provider: { name: 'cloudflare', namespace: env.SANDBOX, getSandbox },
})

// Access Cloudflare-specific features
const { url } = await sandbox.cloudflare.exposePort(8080, {
  hostname: 'preview.example.com',
})
await sandbox.cloudflare.gitCheckout('https://github.com/user/repo')
```
::

See [sandbox-vercel](/modules/providers/sandbox-vercel) and [sandbox-cloudflare](/modules/providers/sandbox-cloudflare) for provider-specific documentation.

### Cloudflare-Only Methods
These methods are fully supported on Cloudflare and throw `NotSupportedError` on Vercel:

```ts
// File operations
await sandbox.listFiles('/app') // Returns FileEntry[]
await sandbox.exists('/app/file.txt') // Returns boolean
await sandbox.deleteFile('/app/file.txt')
await sandbox.moveFile('/app/a.txt', '/app/b.txt')
```

### Type Inference
Factory overloads provide proper type inference:

```ts
// Typed as VercelSandbox
const vercel = await createSandbox({
  provider: { name: 'vercel' },
})
vercel.vercel.domain(3000) // ✓ typed

// Typed as CloudflareSandbox
const cf = await createSandbox({
  provider: { name: 'cloudflare', namespace: env.SANDBOX, getSandbox },
})
cf.cloudflare.exposePort(8080, { hostname: 'preview.example.com' }) // ✓ typed
```

### Options
#### Vercel

Provider-specific options apply only to their provider:

```ts
await createSandbox({
  provider: { name: 'vercel', ports: [3000] },
})
```

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `name` | `'vercel'` | - | Provider name |
| `runtime` | `string` | `'node24'` | Node.js runtime |
| `timeout` | `number` | `300000` | Timeout in ms |
| `cpu` | `number` | - | vCPU count |
| `ports` | `number[]` | - | Ports to expose (enables `sandbox.vercel.domain(port)`) |

### Cloudflare

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `name` | `'cloudflare'` | - | Provider name |
| `namespace` | `DurableObjectNamespace` | - | DO binding (required) |
| `getSandbox` | `function` | auto | Optional override (auto-loaded from `@cloudflare/sandbox`) |
| `sandboxId` | `string` | auto | Custom sandbox ID |
| `cloudflare.sleepAfter` | `string\|number` | - | Auto-sleep duration |
| `cloudflare.keepAlive` | `boolean` | - | Prevent auto-sleep |
| `cloudflare.normalizeId` | `boolean` | - | Normalize sandbox IDs |

### Error Handling
```ts
import { NotSupportedError, SandboxError } from 'unagent/sandbox'

try {
  await sandbox.listFiles('/app')
}
catch (e) {
  if (e instanceof NotSupportedError) {
    console.log('This feature is not supported on', e.message)
  }
}
```

## Examples

### Example: Code Execution Service
```ts
import { createSandbox } from 'unagent/sandbox'

async function runCode(code: string, language: 'js' | 'python') {
  const sandbox = await createSandbox({
    provider: { name: 'vercel', timeout: 30_000 },
  })

  try {
    const ext = language === 'python' ? 'py' : 'js'
    const cmd = language === 'python' ? 'python3' : 'node'

    await sandbox.writeFile(`/app/code.${ext}`, code)
    return await sandbox.exec(cmd, [`/app/code.${ext}`])
  }
  finally {
    await sandbox.stop()
  }
}
```

## Related
- [All Modules](/modules)
