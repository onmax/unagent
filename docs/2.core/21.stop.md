---
icon: i-lucide-stop-circle
---
# stop

> Stop conditions for agent loops. Compose predicates to control when agents terminate based on iterations, tokens, cost, or time.

## What It Solves

Agent loops need clear termination rules to avoid runaway cost and infinite iterations. The `stop` module gives you small predicates and combinators that compose into readable stop logic. Use it to keep “when do we stop?” separate from “what do we do next?”.

## When To Use It

- You run agents in loops and need a hard ceiling on iterations, time, tokens, or spend.
- You want to combine multiple stop criteria without ad-hoc boolean code.
- You want stop behavior that is easy to test and reuse across agents.

## Usage
```ts
import { and, costIs, iterationCountIs, not, or, timeout, tokenCountIs } from 'unagent/stop'
```

## API

### Conditions
#### `iterationCountIs(max)`

Stops when iteration count reaches max.

```ts
const stop = iterationCountIs(10)
stop({ iteration: 10 }) // true
```

### `tokenCountIs(max)`

Stops when total tokens (input + output) reach max.

```ts
const stop = tokenCountIs(100_000)
stop({ usage: { inputTokens: 80_000, outputTokens: 25_000 } }) // true
```

### `costIs(maxDollars, rates)`

Stops when estimated cost reaches threshold.

```ts
import { MODEL_PRICING } from 'unagent/usage'

const stop = costIs(1.00, MODEL_PRICING['claude-3-opus-20240229'])
stop({ usage: { inputTokens: 50_000, outputTokens: 5_000 } })
```

### `timeout(ms)`

Stops after elapsed time.

```ts
const stop = timeout(60_000) // 1 minute
stop({ startTime: Date.now() - 61_000 }) // true
```

### Combinators
#### `and(...conditions)`

All conditions must be true.

```ts
const stop = and(iterationCountIs(5), tokenCountIs(10_000))
```

### `or(...conditions)`

Any condition being true stops the agent.

```ts
const stop = or(iterationCountIs(100), timeout(300_000), costIs(5.00, rates))
```

### `not(condition)`

Inverts a condition.

```ts
const keepGoing = not(timeout(60_000))
```

### Types
```ts
type StopCondition<Ctx> = (ctx: Ctx) => boolean | Promise<boolean>
```

## Examples

### Example: Complex Stop Logic
```ts
import { and, costIs, iterationCountIs, or, timeout } from 'unagent/stop'
import { MODEL_PRICING } from 'unagent/usage'

const rates = MODEL_PRICING['claude-3-5-sonnet-20241022']

// Stop if: (100 iterations AND $2 spent) OR 5 minutes elapsed
const shouldStop = or(
  and(iterationCountIs(100), costIs(2.00, rates)),
  timeout(5 * 60 * 1000),
)

// In agent loop
const ctx = { iteration: 50, usage, startTime }
if (await shouldStop(ctx)) {
  break
}
```

## Related
- [Core](/core)
- [hooks](/core/hooks)
- [usage](/core/usage)
