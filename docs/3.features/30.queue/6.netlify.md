---
icon: i-simple-icons-netlify
---
# Netlify

> Netlify Async Workloads provider for `unagent/queue`.

## Usage

```ts
import { createQueue } from 'unagent/queue'

const queue = await createQueue({
  provider: {
    name: 'netlify',
    event: 'emails.send',
    apiKey: process.env.NETLIFY_API_KEY,
  },
})

const { messageId, sendStatus } = await queue.send(
  { to: 'hello@example.com' },
  {
    delaySeconds: 10,
    priority: 10,
  },
)

if (sendStatus === 'failed')
  throw new Error(`queue send failed for message ${messageId}`)
```

## Scheduling

Use `delayUntil` for absolute or custom delay values:

```ts
await queue.send(
  { to: 'hello@example.com' },
  {
    delayUntil: '2026-02-16T12:00:00Z',
    priority: 0,
  },
)
```

If both are passed, `delayUntil` takes precedence over `delaySeconds`.

## API

```ts
const netlify = queue.netlify
netlify.event // default event configured in provider options
netlify.native // AsyncWorkloadsClient instance

await netlify.send('emails.send', {
  data: { to: 'hello@example.com' },
  delaySeconds: 5,
  priority: 10,
})

const handler = netlify.asyncWorkloadFn(async (event) => {
  await event.step.run('process', async () => {})
})

const DoNotRetry = netlify.ErrorDoNotRetry
const RetryAfter = netlify.ErrorRetryAfterDelay
```

## Limitations
- `sendBatch()` is not supported on Netlify (use `send()`).
- `@netlify/async-workloads` must be installed in your project.

## Playground + Real Netlify E2E
The playground includes a Netlify Async Workload consumer at:

`playground/netlify/functions/queue-background.mjs`

It listens to the queue event configured by `NETLIFY_QUEUE_EVENT` (defaults to `unagent.playground.queue`) and writes deterministic receipts used by E2E checks.

Use `NETLIFY_ASYNC_WORKLOADS_BASE_URL` when you need to send to a custom Async Workloads endpoint; when omitted, the Netlify SDK default endpoint is used.

### Redeploy + Run E2E

```bash
pnpm playground:queue:netlify:e2e -- --config /Users/maxi/unjs/unagent/playground/scripts/queue-netlify-e2e.config.example.json
```

The E2E runner does:

- preview deploy bootstrap (`netlify deploy --json --dir="$PWD/public" --no-build`)
- queue API checks (`supports`, `send`, `sendBatch`)
- deterministic background trigger (`/.netlify/functions/queue-background`) using the generated message ID
- receipt polling (`/api/queue/netlify/receipts`) to prove background execution

### Manual curl fallback

```bash
BASE_URL="https://<preview-or-site>.netlify.app"
RUN_ID="manual-$(date +%s)"

curl -s "$BASE_URL/api/health"
curl -s "$BASE_URL/api/queue/netlify/supports"
curl -s -X POST "$BASE_URL/api/queue/netlify/receipts/clear" \
  -H 'content-type: application/json' \
  --data "{\"runId\":\"$RUN_ID\"}"
SEND_JSON="$(curl -s -X POST "$BASE_URL/api/queue/netlify/send" \
  -H 'content-type: application/json' \
  --data "{\"payload\":{\"hello\":\"manual\",\"runId\":\"$RUN_ID\"},\"options\":{\"delaySeconds\":1}}")"
echo "$SEND_JSON"

MESSAGE_ID="<messageId from SEND_JSON>"
EVENT_NAME="${NETLIFY_QUEUE_EVENT:-unagent.playground.queue}"
curl -s -X POST "$BASE_URL/.netlify/functions/queue-background?events=%5B%22$EVENT_NAME%22%5D" \
  -H 'content-type: application/json' \
  -H 'x-unagent-e2e: 1' \
  --data "[{\"eventName\":\"$EVENT_NAME\",\"eventId\":\"$MESSAGE_ID\",\"data\":{\"runId\":\"$RUN_ID\"},\"attemptContext\":{\"attempt\":0}}]"
```

Then query receipts:

```bash
curl -s "$BASE_URL/api/queue/netlify/receipts?runId=$RUN_ID&eventId=$MESSAGE_ID"
```

## Related
- [Queue](/features/queue)
- [All Features](/features)
- [Core](/core)
